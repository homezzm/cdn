$.extend($.fn.datagrid.defaults,{groupHeight:28,expanderWidth:30,groupStyler:function(){return""}});var groupview=$.extend({},$.fn.datagrid.defaults.view,{render:function(a,b,c){var f,d=[],e=this.groups;for(f=0;f<e.length;f++)d.push(this.renderGroup.call(this,a,f,e[f],c));$(b).html(d.join(""))},renderGroup:function(a,b,c,d){function s(a,b){var c="",d="";return"string"==typeof a?d=a:a&&(c=a["class"]||"",d=a["style"]||""),'class="'+b+(c?" "+c:"")+'" '+'style="'+d+'"'}var i,j,k,l,m,n,o,p,q,r,e=$.data(a,"datagrid"),f=e.options,g=$(a).datagrid("getColumnFields",d),h=f.frozenColumns&&f.frozenColumns.length;if(d&&!f.rownumbers&&!h)return"";for(i=[],j=f.groupStyler.call(a,c.value,c.rows),k=s(j,"datagrid-group"),i.push("<div group-index="+b+" "+k+">"),(d&&(f.rownumbers||f.frozenColumns.length)||!d&&!f.rownumbers&&!f.frozenColumns.length)&&(i.push('<span class="datagrid-group-expander">'),i.push('<span class="datagrid-row-expander datagrid-row-collapse">&nbsp;</span>'),i.push("</span>")),(d&&h||!d)&&(i.push('<span class="datagrid-group-title">'),i.push(f.groupFormatter.call(a,c.value,c.rows)),i.push("</span>")),i.push("</div>"),i.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>'),l=c.startIndex,m=0;m<c.rows.length;m++)j=f.rowStyler?f.rowStyler.call(a,l,c.rows[m]):"",n="",o="","string"==typeof j?o=j:j&&(n=j["class"]||"",o=j["style"]||""),p='class="datagrid-row '+(l%2&&f.striped?"datagrid-row-alt ":" ")+n+'"',q=o?'style="'+o+'"':"",r=e.rowIdPrefix+"-"+(d?1:2)+"-"+l,i.push('<tr id="'+r+'" datagrid-row-index="'+l+'" '+p+" "+q+">"),i.push(this.renderRow.call(this,a,g,d,l,c.rows[m])),i.push("</tr>"),l++;return i.push("</tbody></table>"),i.join("")},bindEvents:function(a){var b=$.data(a,"datagrid"),c=b.dc,d=c.body1.add(c.body2),e=($.data(d[0],"events")||$._data(d[0],"events")).click[0].handler;d.unbind("click").bind("click",function(b){var f,c=$(b.target),d=c.closest("span.datagrid-row-expander");d.length?(f=d.closest("div.datagrid-group").attr("group-index"),d.hasClass("datagrid-row-collapse")?$(a).datagrid("collapseGroup",f):$(a).datagrid("expandGroup",f)):e(b),b.stopPropagation()})},onBeforeRender:function(a,b){function l(a){var b,c;for(b=0;b<e.length;b++)if(c=e[b],c.value==a)return c;return null}function m(){$("#datagrid-group-style").length||$("head").append('<style id="datagrid-group-style">.datagrid-group{height:'+d.groupHeight+"px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;white-space:nowrap;word-break:normal;}"+".datagrid-group-title,.datagrid-group-expander{display:inline-block;vertical-align:bottom;height:100%;line-height:"+d.groupHeight+"px;padding:0 4px;}"+".datagrid-group-title{position:relative;}"+".datagrid-group-expander{width:"+d.expanderWidth+"px;text-align:center;padding:0}"+".datagrid-row-expander{margin:"+Math.floor((d.groupHeight-16)/2)+"px 0;display:inline-block;width:16px;height:16px;cursor:pointer}"+"</style>")}var e,f,g,h,i,j,k,c=$.data(a,"datagrid"),d=c.options;for(m(),e=[],f=0;f<b.length;f++)g=b[f],h=l(g[d.groupField]),h?h.rows.push(g):(h={value:g[d.groupField],rows:[g]},e.push(h));for(i=0,j=[],f=0;f<e.length;f++)h=e[f],h.startIndex=i,i+=h.rows.length,j=j.concat(h.rows);c.data.rows=j,this.groups=e,k=this,setTimeout(function(){k.bindEvents(a)},0)},onAfterRender:function(a){var b,c,d;$.fn.datagrid.defaults.view.onAfterRender.call(this,a),b=this,c=$.data(a,"datagrid"),d=c.options,c.onResizeColumn||(c.onResizeColumn=d.onResizeColumn),c.onResize||(c.onResize=d.onResize),d.onResizeColumn=function(d,e){b.resizeGroup(a),c.onResizeColumn.call(a,d,e)},d.onResize=function(d,e){b.resizeGroup(a),c.onResize.call($(a).datagrid("getPanel")[0],d,e)},b.resizeGroup(a)}});$.extend($.fn.datagrid.methods,{groups:function(a){return a.datagrid("options").view.groups},expandGroup:function(a,b){return a.each(function(){var a=$(this).datagrid("options"),c=$.data(this,"datagrid").dc.view,d=c.find(void 0!=b?'div.datagrid-group[group-index="'+b+'"]':"div.datagrid-group"),e=d.find("span.datagrid-row-expander");e.hasClass("datagrid-row-expand")&&(e.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse"),d.next("table").show()),$(this).datagrid("fixRowHeight"),a.onExpandGroup&&a.onExpandGroup.call(this,b)})},collapseGroup:function(a,b){return a.each(function(){var a=$(this).datagrid("options"),c=$.data(this,"datagrid").dc.view,d=c.find(void 0!=b?'div.datagrid-group[group-index="'+b+'"]':"div.datagrid-group"),e=d.find("span.datagrid-row-expander");e.hasClass("datagrid-row-collapse")&&(e.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand"),d.next("table").hide()),$(this).datagrid("fixRowHeight"),a.onCollapseGroup&&a.onCollapseGroup.call(this,b)})},scrollToGroup:function(a,b){return a.each(function(){var e,f,g,h,a=$.data(this,"datagrid"),c=a.dc,d=c.body2.children('div.datagrid-group[group-index="'+b+'"]');d.length&&(e=d.outerHeight(),f=c.view2.children("div.datagrid-header")._outerHeight(),g=c.body2.outerHeight(!0)-c.body2.outerHeight(),h=d.position().top-f-g,0>h?c.body2.scrollTop(c.body2.scrollTop()+h):h+e>c.body2.height()-18&&c.body2.scrollTop(c.body2.scrollTop()+h+e-c.body2.height()+18))})}}),$.extend(groupview,{refreshGroupTitle:function(a,b){var c=$.data(a,"datagrid"),d=c.options,e=c.dc,f=this.groups[b],g=e.body1.add(e.body2).children("div.datagrid-group[group-index="+b+"]").find("span.datagrid-group-title");g.html(d.groupFormatter.call(a,f.value,f.rows))},resizeGroup:function(a,b){var h,i,j,k,c=$.data(a,"datagrid"),d=c.dc,e=d.header2.find("table"),f=e.find("tr.datagrid-filter-row").hide(),g=d.body2.children("table.datagrid-btable:first").width();h=void 0==b?d.body2.children("div.datagrid-group"):d.body2.children("div.datagrid-group[group-index="+b+"]"),h._outerWidth(g),i=c.options,i.frozenColumns&&i.frozenColumns.length&&(j=d.view1.width()-i.expanderWidth,k="rtl"==d.view1.css("direction").toLowerCase(),h.find(".datagrid-group-title").css(k?"right":"left",-j+"px")),f.length&&i.showFilterBar&&f.show()},insertRow:function(a,b,c){function j(b,c){var d=c?1:2,f=e.finder.getTr(a,b-1,"body",d),g=e.finder.getTr(a,b,"body",d);g.insertAfter(f)}var h,i,d=$.data(a,"datagrid"),e=d.options,f=d.dc,g=null;if(!d.data.rows.length)return $(a).datagrid("loadData",[c]),void 0;for(i=0;i<this.groups.length;i++)if(this.groups[i].value==c[e.groupField]){g=this.groups[i],h=i;break}g?((void 0==b||null==b)&&(b=d.data.rows.length),b<g.startIndex?b=g.startIndex:b>g.startIndex+g.rows.length&&(b=g.startIndex+g.rows.length),$.fn.datagrid.defaults.view.insertRow.call(this,a,b,c),b>=g.startIndex+g.rows.length&&(j(b,!0),j(b,!1)),g.rows.splice(b-g.startIndex,0,c)):(g={value:c[e.groupField],rows:[c],startIndex:d.data.rows.length},h=this.groups.length,f.body1.append(this.renderGroup.call(this,a,h,g,!0)),f.body2.append(this.renderGroup.call(this,a,h,g,!1)),this.groups.push(g),d.data.rows.push(c)),this.setGroupIndex(a),this.refreshGroupTitle(a,h),this.resizeGroup(a)},updateRow:function(a,b,c){var e,f,d=$.data(a,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,a,b,c),e=d.finder.getTr(a,b,"body",2).closest("table.datagrid-btable"),f=parseInt(e.prev().attr("group-index")),this.refreshGroupTitle(a,f)},deleteRow:function(a,b){var i,j,c=$.data(a,"datagrid"),d=c.options,e=c.dc,f=e.body1.add(e.body2),g=d.finder.getTr(a,b,"body",2).closest("table.datagrid-btable"),h=parseInt(g.prev().attr("group-index"));if($.fn.datagrid.defaults.view.deleteRow.call(this,a,b),i=this.groups[h],i.rows.length>1)i.rows.splice(b-i.startIndex,1),this.refreshGroupTitle(a,h);else{for(f.children("div.datagrid-group[group-index="+h+"]").remove(),j=h+1;j<this.groups.length;j++)f.children("div.datagrid-group[group-index="+j+"]").attr("group-index",j-1);this.groups.splice(h,1)}this.setGroupIndex(a)},setGroupIndex:function(){var c,d,b=0;for(c=0;c<this.groups.length;c++)d=this.groups[c],d.startIndex=b,b+=d.rows.length}});